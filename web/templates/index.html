<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åˆ†æ - TradingAgents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .markdown-content h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.5rem; }
        .markdown-content p { margin: 0.5rem 0; }
        .markdown-content ul { list-style: disc; margin-left: 1.5rem; }
        .markdown-content li { margin: 0.25rem 0; }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-12 relative">
            <!-- Navigation -->
            <div class="absolute left-0 top-0 flex gap-2">
                <a href="/dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center space-x-2 transition-colors">
                    <i class="fas fa-home"></i>
                    <span>ä¿¡æ¯ä¸­å¿ƒ</span>
                </a>
            </div>
            <!-- User Info & Logout -->
            <div class="absolute right-0 top-0 flex items-center gap-3">
                <div id="userInfo" class="flex items-center gap-2">
                    <div id="userAvatar" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user text-gray-400 text-sm"></i>
                    </div>
                    <span id="userName" class="text-gray-300 text-sm hidden md:inline"></span>
                    <span id="quotaInfo" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400 hidden"></span>
                </div>
                <a href="/logout" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm flex items-center space-x-2 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>é€€å‡º</span>
                </a>
            </div>
            
            <h1 class="text-5xl font-bold mb-4">
                ğŸ¤– <span class="bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">TradingAgents</span>
            </h1>
            <p class="text-gray-400 text-lg">å¤šæ™ºèƒ½ä½“ AI é‡‘èäº¤æ˜“åˆ†ææ¡†æ¶</p>
            <p class="text-gray-500 text-sm mt-2">
                åˆ†æå›¢é˜Ÿ â†’ ç ”ç©¶å›¢é˜Ÿ â†’ äº¤æ˜“å‘˜ â†’ é£é™©ç®¡ç† â†’ æŠ•èµ„ç»„åˆç®¡ç†
            </p>
        </header>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Configuration Panel -->
            <div class="lg:col-span-1">
                <div class="card rounded-2xl p-6 sticky top-8">
                    <h2 class="text-xl font-semibold mb-6 flex items-center">
                        <span class="mr-2">âš™ï¸</span> é…ç½®
                    </h2>
                    
                    <form id="analysisForm" class="space-y-5">
                        <!-- Ticker -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" id="ticker" value="NVDA" 
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="ä¾‹å¦‚: AAPL, NVDA, META">
                        </div>

                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åˆ†ææ—¥æœŸ</label>
                            <input type="date" id="date" 
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <!-- LLM Provider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">LLM æä¾›å•†</label>
                            <select id="llmProvider" 
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                                <option value="deepseek" selected>DeepSeek (æ¨è)</option>
                                <option value="google">Google (Gemini)</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openrouter">OpenRouter (Free)</option>
                                <option value="ollama">Ollama (Local)</option>
                            </select>
                        </div>

                        <!-- Quick Think Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Quick-Think Model</label>
                            <select id="quickModel" 
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </select>
                        </div>

                        <!-- Deep Think Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Deep-Think Model</label>
                            <select id="deepModel" 
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </select>
                        </div>

                        <!-- Analysts -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Analysts</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700">
                                    <input type="checkbox" value="market" checked class="analyst-checkbox rounded">
                                    <span class="text-sm">ğŸ“Š Market</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700">
                                    <input type="checkbox" value="news" checked class="analyst-checkbox rounded">
                                    <span class="text-sm">ğŸ“° News</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700">
                                    <input type="checkbox" value="fundamentals" checked class="analyst-checkbox rounded">
                                    <span class="text-sm">ğŸ“ˆ Fundamentals</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700">
                                    <input type="checkbox" value="social" checked class="analyst-checkbox rounded">
                                    <span class="text-sm">ğŸ’¬ Social</span>
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" id="submitBtn"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                            <span>ğŸš€</span>
                            <span>å¼€å§‹åˆ†æ</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="lg:col-span-2">
                <!-- Status -->
                <div id="statusCard" class="card rounded-2xl p-6 mb-6 hidden">
                    <div class="flex items-center space-x-4">
                        <div id="statusIndicator" class="w-4 h-4 rounded-full bg-yellow-500 pulse-dot"></div>
                        <div>
                            <h3 class="font-semibold" id="statusTitle">å¤„ç†ä¸­...</h3>
                            <p class="text-gray-400 text-sm" id="statusMessage">æ­£åœ¨åˆå§‹åŒ–ä»£ç†...</p>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div id="resultsContainer" class="space-y-6 hidden">
                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-3">
                        <button id="exportPdfBtn" onclick="exportPDF()" 
                            class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            å¯¼å‡º PDF
                        </button>
                    </div>

                    <!-- Decision Card - Chinese First -->
                    <div class="card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="mr-2">ğŸ¯</span> äº¤æ˜“å†³ç­– <span class="text-sm text-gray-400 ml-2">(Trading Decision)</span>
                        </h2>
                        <!-- Chinese Decision -->
                        <div id="decisionContentZh" class="bg-gray-800 rounded-lg p-4 markdown-content mb-4 border-l-4 border-red-500">
                            <div class="text-xs text-red-400 mb-2 font-medium">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</div>
                            <div id="decisionZhText"></div>
                        </div>
                        <!-- English Decision -->
                        <details class="bg-gray-700/50 rounded-lg">
                            <summary class="px-4 py-3 cursor-pointer hover:bg-gray-700 rounded-lg font-medium text-sm text-gray-400">
                                ğŸ‡ºğŸ‡¸ View English Original
                            </summary>
                            <div id="decisionContentEn" class="px-4 py-3 border-t border-gray-600 markdown-content text-sm text-gray-300">
                            </div>
                        </details>
                    </div>

                    <!-- Reports Accordion -->
                    <div class="card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="mr-2">ğŸ“‹</span> åˆ†ææŠ¥å‘Š <span class="text-sm text-gray-400 ml-2">(Analysis Reports)</span>
                        </h2>
                        <div class="space-y-3" id="reportsAccordion">
                            <!-- Reports will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="card rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">ğŸ“Š</div>
                    <h3 class="text-xl font-semibold mb-2">Ready to Analyze</h3>
                    <p class="text-gray-400">Configure your analysis parameters and click "Start Analysis" to begin.</p>
                </div>

                <!-- History Panel -->
                <div id="historyPanel" class="card rounded-2xl p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <span class="mr-2">ğŸ“œ</span> Search History
                        </h2>
                        <button onclick="clearHistory()" class="text-sm text-red-400 hover:text-red-300 transition-colors">
                            ğŸ—‘ï¸ Clear All
                        </button>
                    </div>
                    <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-4">No history yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Built with TradingAgents Framework | 
                <a href="/docs" class="text-blue-400 hover:underline">API Docs</a> |
                <a href="https://github.com/TauricResearch/TradingAgents" class="text-blue-400 hover:underline">GitHub</a>
            </p>
            <p class="mt-2 text-xs">âš ï¸ This is for research purposes only. Not financial advice.</p>
        </footer>
    </div>

    <script>
        // Configuration data
        let configData = null;
        let currentTaskId = null;  // Store current task ID for PDF export

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    const userName = document.getElementById('userName');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (user.name || user.username) {
                        userName.textContent = user.name || user.username;
                    }
                    if (user.avatar_url) {
                        userAvatar.innerHTML = `<img src="${user.avatar_url}" class="w-full h-full object-cover" alt="avatar">`;
                    }
                    
                    // Show quota info for GitHub OAuth users
                    if (user.daily_limit > 0) {
                        updateQuotaDisplay(user.daily_limit, user.used_today, user.remaining_today);
                    }
                }
            } catch (e) {
                console.log('Failed to load user info');
            }
        }
        
        // Update quota display
        function updateQuotaDisplay(limit, used, remaining) {
            const quotaInfo = document.getElementById('quotaInfo');
            if (quotaInfo && limit > 0) {
                quotaInfo.classList.remove('hidden');
                if (remaining > 0) {
                    quotaInfo.textContent = `å‰©ä½™ ${remaining}/${limit} æ¬¡`;
                    quotaInfo.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-green-400';
                } else {
                    quotaInfo.textContent = `ä»Šæ—¥å·²ç”¨å®Œ (${limit}æ¬¡/å¤©)`;
                    quotaInfo.className = 'text-xs px-2 py-1 rounded bg-red-900/50 text-red-400';
                    // Disable submit button
                    const submitBtn = document.getElementById('submitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.title = 'ä»Šæ—¥åˆ†ææ¬¡æ•°å·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥';
                    }
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load user info
            loadUserInfo();
            
            // Set default date
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Load config
            try {
                const response = await fetch('/api/config');
                configData = await response.json();
                updateModelOptions();
            } catch (e) {
                console.error('Failed to load config:', e);
            }
            
            // Provider change handler
            document.getElementById('llmProvider').addEventListener('change', updateModelOptions);
            
            // Load history
            loadHistory();
        });

        // Load search history
        async function loadHistory() {
            try {
                const response = await fetch('/api/history?limit=20');
                if (response.ok) {
                    const data = await response.json();
                    renderHistory(data.history);
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        // Render history list
        function renderHistory(history) {
            const container = document.getElementById('historyList');
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No history yet</p>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                const hasFullResult = item.full_result !== null && item.full_result !== undefined;
                return `
                <div class="bg-gray-800/50 rounded-lg p-4 hover:bg-gray-800 transition-colors border border-gray-700/50">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${item.status === 'completed' ? 'âœ…' : 'âŒ'}</span>
                            <div>
                                <div class="font-semibold text-lg">${item.ticker}</div>
                                <div class="text-sm text-gray-400">${item.date} Â· ${item.llm_provider.toUpperCase()}</div>
                                <div class="text-xs text-gray-500 mt-1">${item.created_at}</div>
                            </div>
                        </div>
                        ${item.status === 'completed' && hasFullResult ? `
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); viewHistoryDetail('${item.task_id}')" 
                                class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                <span>ğŸ‘ï¸</span> View
                            </button>
                            <div class="relative" onclick="event.stopPropagation();">
                                <button onclick="toggleDownloadMenu('${item.task_id}')" 
                                    class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                    <span>ğŸ“¥</span> Download
                                </button>
                                <div id="download-menu-${item.task_id}" class="hidden absolute right-0 mt-1 bg-gray-700 rounded-lg shadow-lg z-10 py-1 min-w-28">
                                    <a href="/api/history/${item.task_id}/download?format=pdf" class="block px-4 py-2 text-sm hover:bg-gray-600 flex items-center gap-2">
                                        <span>ğŸ“„</span> PDF
                                    </a>
                                    <a href="/api/history/${item.task_id}/download?format=md" class="block px-4 py-2 text-sm hover:bg-gray-600 flex items-center gap-2">
                                        <span>ğŸ“</span> Markdown
                                    </a>
                                    <a href="/api/history/${item.task_id}/download?format=txt" class="block px-4 py-2 text-sm hover:bg-gray-600 flex items-center gap-2">
                                        <span>ğŸ“ƒ</span> Text
                                    </a>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ${item.decision_summary ? `
                    <div class="mt-3 text-sm text-gray-300 bg-gray-900/50 rounded-lg p-3 border-l-4 border-blue-500">
                        ${item.decision_summary}
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        // Toggle download menu
        function toggleDownloadMenu(taskId) {
            const menu = document.getElementById(`download-menu-${taskId}`);
            // Close all other menus
            document.querySelectorAll('[id^="download-menu-"]').forEach(m => {
                if (m.id !== `download-menu-${taskId}`) m.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[id^="download-menu-"]') && !e.target.closest('button')) {
                document.querySelectorAll('[id^="download-menu-"]').forEach(m => m.classList.add('hidden'));
            }
        });

        // View history detail
        async function viewHistoryDetail(taskId) {
            try {
                const response = await fetch(`/api/history/${taskId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.result) {
                        // Full result available
                        currentTaskId = taskId;
                        // Hide empty state, show results
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('statusCard').classList.add('hidden');
                        showResults(data.result);
                        // Scroll to results
                        document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
                    } else if (data.history_record) {
                        alert(`Record for ${data.history_record.ticker} (${data.history_record.date})\n\nStatus: ${data.history_record.status}\nSummary: ${data.history_record.decision_summary || 'N/A'}\n\nFull results are not available.`);
                    }
                } else {
                    alert('Failed to load history detail');
                }
            } catch (e) {
                console.error('Failed to load history detail:', e);
                alert('Error loading history: ' + e.message);
            }
        }

        // Clear history
        async function clearHistory() {
            if (!confirm('Are you sure you want to clear all history? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/history', { method: 'DELETE' });
                if (response.ok) {
                    loadHistory();
                }
            } catch (e) {
                console.error('Failed to clear history:', e);
            }
        }

        function updateModelOptions() {
            const provider = document.getElementById('llmProvider').value;
            const quickSelect = document.getElementById('quickModel');
            const deepSelect = document.getElementById('deepModel');
            
            if (!configData || !configData.models[provider]) return;
            
            const models = configData.models[provider];
            
            quickSelect.innerHTML = models.quick.map(m => 
                `<option value="${m}">${m}</option>`
            ).join('');
            
            deepSelect.innerHTML = models.deep.map(m => 
                `<option value="${m}">${m}</option>`
            ).join('');
        }

        // Form submission
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const analysts = Array.from(document.querySelectorAll('.analyst-checkbox:checked'))
                .map(cb => cb.value);
            
            if (analysts.length === 0) {
                alert('Please select at least one analyst');
                return;
            }
            
            const request = {
                ticker: document.getElementById('ticker').value.toUpperCase(),
                date: document.getElementById('date').value,
                llm_provider: document.getElementById('llmProvider').value,
                quick_think_llm: document.getElementById('quickModel').value,
                deep_think_llm: document.getElementById('deepModel').value,
                analysts: analysts,
                max_debate_rounds: 1
            };
            
            // Start analysis
            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').innerHTML = '<span class="animate-spin">â³</span> Processing...';
                
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('statusCard').classList.remove('hidden');
                document.getElementById('resultsContainer').classList.add('hidden');
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                // Check for quota exceeded (429)
                if (response.status === 429) {
                    const errorData = await response.json();
                    const detail = errorData.detail || {};
                    const message = detail.message || 'ä»Šæ—¥åˆ†ææ¬¡æ•°å·²ç”¨å®Œ';
                    showError(`âš ï¸ ${message}\næ¯æ—¥é™åˆ¶: ${detail.limit || 1} æ¬¡\nå·²ä½¿ç”¨: ${detail.used || 1} æ¬¡`);
                    resetButton();
                    // Update quota display
                    updateQuotaDisplay(detail.limit || 1, detail.used || 1, 0);
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Analysis failed');
                }
                
                const data = await response.json();
                currentTaskId = data.task_id;  // Save task ID for PDF export
                pollStatus(data.task_id);
                
            } catch (error) {
                showError(error.message);
                resetButton();
            }
        });

        async function pollStatus(taskId) {
            try {
                const response = await fetch(`/api/status/${taskId}`);
                const data = await response.json();
                
                updateStatus(data.status, data.progress);
                
                if (data.status === 'completed') {
                    showResults(data.result);
                    resetButton();
                } else if (data.status === 'failed') {
                    showError(data.error);
                    resetButton();
                } else {
                    setTimeout(() => pollStatus(taskId), 2000);
                }
            } catch (error) {
                showError(error.message);
                resetButton();
            }
        }

        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const title = document.getElementById('statusTitle');
            const msg = document.getElementById('statusMessage');
            
            const colors = {
                'pending': 'bg-yellow-500',
                'running': 'bg-blue-500',
                'completed': 'bg-green-500',
                'failed': 'bg-red-500'
            };
            
            indicator.className = `w-4 h-4 rounded-full ${colors[status] || 'bg-gray-500'} ${status === 'running' ? 'pulse-dot' : ''}`;
            title.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            msg.textContent = message || '';
        }

        function showResults(result) {
            // Save result for reference
            currentResult = result;
            
            displayResults(result);
            
            // Refresh history after new analysis
            loadHistory();
        }

        function displayResults(result) {
            document.getElementById('resultsContainer').classList.remove('hidden');
            
            const translated = result.translated || {};
            const hasTranslation = translated && Object.keys(translated).length > 0;
            
            // Decision - Chinese first, then English
            const decisionZh = translated.decision || '';
            const decisionEn = result.decision || 'No decision available';
            
            if (hasTranslation && decisionZh) {
                document.getElementById('decisionZhText').innerHTML = formatMarkdown(decisionZh);
                document.getElementById('decisionContentZh').style.display = 'block';
            } else {
                // No translation, show English in main area
                document.getElementById('decisionZhText').innerHTML = '<span class="text-gray-400 italic">ç¿»è¯‘ä¸å¯ç”¨ï¼Œè¯·æŸ¥çœ‹è‹±æ–‡åŸæ–‡</span>';
            }
            document.getElementById('decisionContentEn').innerHTML = formatMarkdown(decisionEn);
            
            // Reports - Chinese first, then English in collapsible
            const reportsEn = result.reports || {};
            const reportsZh = translated.reports || {};
            
            const reportNames = {
                'market': { zh: 'å¸‚åœºåˆ†æ', en: 'Market Analysis', icon: 'ğŸ“Š' },
                'news': { zh: 'æ–°é—»åˆ†æ', en: 'News Analysis', icon: 'ğŸ“°' },
                'fundamentals': { zh: 'åŸºæœ¬é¢åˆ†æ', en: 'Fundamentals Analysis', icon: 'ğŸ“ˆ' },
                'sentiment': { zh: 'æƒ…ç»ªåˆ†æ', en: 'Sentiment Analysis', icon: 'ğŸ’¬' }
            };
            
            const reportsHtml = Object.entries(reportsEn)
                .filter(([_, content]) => content)
                .map(([name, contentEn]) => {
                    const info = reportNames[name] || { zh: name, en: name, icon: 'ğŸ“‹' };
                    const contentZh = reportsZh[name] || '';
                    
                    return `
                    <details class="bg-gray-800 rounded-lg" open>
                        <summary class="px-4 py-3 cursor-pointer hover:bg-gray-700 rounded-lg font-medium">
                            ${info.icon} ${info.zh} <span class="text-sm text-gray-400">(${info.en})</span>
                        </summary>
                        <div class="px-4 py-3 border-t border-gray-700">
                            ${contentZh ? `
                            <div class="mb-4 bg-gray-900/50 rounded-lg p-4 border-l-4 border-red-500">
                                <div class="text-xs text-red-400 mb-2 font-medium">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</div>
                                <div class="markdown-content text-sm text-gray-200">${formatMarkdown(contentZh)}</div>
                            </div>
                            ` : ''}
                            <details class="bg-gray-700/30 rounded-lg">
                                <summary class="px-3 py-2 cursor-pointer hover:bg-gray-700/50 rounded-lg text-sm text-gray-400">
                                    ğŸ‡ºğŸ‡¸ View English Original
                                </summary>
                                <div class="px-3 py-2 border-t border-gray-600 markdown-content text-sm text-gray-400">
                                    ${formatMarkdown(contentEn)}
                                </div>
                            </details>
                        </div>
                    </details>
                `}).join('');
            
            document.getElementById('reportsAccordion').innerHTML = reportsHtml || '<p class="text-gray-400">No reports available</p>';
        }

        function getReportIcon(name) {
            const icons = {
                'market': 'ğŸ“Š',
                'sentiment': 'ğŸ’¬',
                'news': 'ğŸ“°',
                'fundamentals': 'ğŸ“ˆ'
            };
            return icons[name] || 'ğŸ“‹';
        }

        function formatMarkdown(text) {
            if (!text) return '';
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)(<br>|$)/g, '<h3>$1</h3>')
                .replace(/## (.*?)(<br>|$)/g, '<h2>$1</h2>')
                .replace(/# (.*?)(<br>|$)/g, '<h1>$1</h1>');
        }

        function showError(message) {
            updateStatus('failed', message);
        }

        function resetButton() {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<span>ğŸš€</span><span>å¼€å§‹åˆ†æ</span>';
        }

        // Store current result
        let currentResult = null;

        // PDF Export function
        async function exportPDF() {
            if (!currentTaskId) {
                alert('æš‚æ— å¯å¯¼å‡ºçš„åˆ†æç»“æœ');
                return;
            }
            
            const btn = document.getElementById('exportPdfBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ç”Ÿæˆä¸­...';
            
            try {
                const response = await fetch(`/api/export/pdf/${currentTaskId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TradingAgents_${document.getElementById('ticker').value}_${document.getElementById('date').value}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    alert('å¯¼å‡ºå¤±è´¥: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
