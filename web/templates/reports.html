<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回测报告 - TradingAgents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <nav class="bg-gray-900/90 backdrop-blur-sm border-b border-gray-700 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-blue-400 hover:text-blue-300">首页</a>
                <a href="/strategies" class="text-gray-300 hover:text-white">回测</a>
                <a href="/strategy-library" class="text-gray-300 hover:text-white">策略库</a>
                <a href="/signals" class="text-gray-300 hover:text-white">信号</a>
                <a href="/data-hub" class="text-gray-300 hover:text-white">数据</a>
            </div>
            <a href="/logout" class="text-gray-400 hover:text-white">退出</a>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto p-6 space-y-6">
        <header>
            <h1 class="text-3xl font-bold">回测报告与分析</h1>
            <p class="text-gray-400">选择历史回测记录查看综合指标、收益曲线与回撤。</p>
        </header>

        <section class="bg-gray-800/60 border border-gray-700 rounded-xl p-6">
            <label class="block text-sm text-gray-300 mb-2">回测记录</label>
            <select id="backtestSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"></select>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4" id="summaryCards"></section>

        <section class="bg-gray-800/60 border border-gray-700 rounded-xl p-6">
            <canvas id="equityChart" height="120"></canvas>
        </section>

        <section class="bg-gray-800/60 border border-gray-700 rounded-xl p-6">
            <canvas id="drawdownChart" height="120"></canvas>
        </section>

        <section class="bg-gray-800/60 border border-gray-700 rounded-xl p-6 text-sm text-gray-300">
            <h2 class="text-lg font-semibold mb-2">结果解读提示</h2>
            <p>回撤曲线越平稳代表风险控制更好，若收益曲线波动大需关注仓位管理。</p>
            <p>波动率和夏普比率结合评估风险收益比，收益高但波动剧烈的策略需谨慎。</p>
        </section>
    </div>

    <script>
        let equityChart;
        let drawdownChart;

        async function loadBacktests() {
            const res = await fetch("/api/backtests");
            const data = await res.json();
            const select = document.getElementById("backtestSelect");
            select.innerHTML = "";
            data.backtests.forEach(b => {
                const option = document.createElement("option");
                option.value = b.id;
                option.textContent = `${b.ticker} | ${b.start_date} - ${b.end_date}`;
                select.appendChild(option);
            });
            if (data.backtests.length) {
                await loadReport(data.backtests[0].id);
            }
        }

        function renderSummary(summary) {
            const cards = [
                { label: "总收益", value: `${summary.total_return?.toFixed(2)}%` },
                { label: "年化收益", value: `${summary.annualized_return?.toFixed(2)}%` },
                { label: "最大回撤", value: `${summary.max_drawdown?.toFixed(2)}%` },
                { label: "波动率", value: `${summary.volatility?.toFixed(2)}%` },
                { label: "胜率", value: `${summary.win_rate?.toFixed(2)}%` },
                { label: "交易次数", value: summary.total_trades }
            ];

            document.getElementById("summaryCards").innerHTML = cards.map(card => `
                <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-4">
                    <div class="text-sm text-gray-400">${card.label}</div>
                    <div class="text-xl font-semibold">${card.value}</div>
                </div>
            `).join("");
        }

        function renderCharts(series) {
            const labels = series.equity_curve.map((_, idx) => idx + 1);

            if (equityChart) equityChart.destroy();
            equityChart = new Chart(document.getElementById("equityChart"), {
                type: "line",
                data: {
                    labels,
                    datasets: [{ label: "收益曲线", data: series.equity_curve, borderColor: "#3b82f6", fill: false }]
                }
            });

            if (drawdownChart) drawdownChart.destroy();
            drawdownChart = new Chart(document.getElementById("drawdownChart"), {
                type: "line",
                data: {
                    labels,
                    datasets: [{ label: "回撤曲线", data: series.drawdown.map(v => v * 100), borderColor: "#ef4444", fill: false }]
                }
            });
        }

        async function loadReport(backtestId) {
            const res = await fetch(`/api/reports/backtest/${backtestId}`);
            const data = await res.json();
            const report = data.report;
            renderSummary(report.summary);
            renderCharts(report.series);
        }

        document.getElementById("backtestSelect").addEventListener("change", (e) => {
            loadReport(e.target.value);
        });

        loadBacktests();
    </script>
</body>
</html>
