<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量化策略回测 - TradingAgents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .strategy-card {
            transition: all 0.3s ease;
        }
        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Navigation -->
    <nav class="bg-gray-900/90 backdrop-blur-sm border-b border-gray-700 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-blue-400 hover:text-blue-300">
                    <i class="fas fa-home"></i> 首页
                </a>
                <a href="/strategy-library" class="text-gray-300 hover:text-white">策略库</a>
                <a href="/strategy-editor" class="text-gray-300 hover:text-white">策略编辑器</a>
                <a href="/stock-library" class="text-gray-300 hover:text-white">股票适配库</a>
                <a href="/reports" class="text-gray-300 hover:text-white">报告</a>
                <a href="/signals" class="text-gray-300 hover:text-white">信号</a>
                <a href="/data-hub" class="text-gray-300 hover:text-white">数据备份</a>
                <span class="text-gray-500">|</span>
                <h1 class="text-xl font-bold">量化策略回测平台</h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="/logout" class="text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Filter Section -->
        <div class="bg-gray-800/50 rounded-xl p-6 mb-6 border border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">策略类型</label>
                    <select id="filterType" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">全部</option>
                        <option value="trend_following">趋势跟踪</option>
                        <option value="mean_reversion">均值回归</option>
                        <option value="momentum">动量策略</option>
                        <option value="breakout">突破策略</option>
                        <option value="value">价值投资</option>
                        <option value="growth">成长股</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">策略类别</label>
                    <select id="filterCategory" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">全部</option>
                        <option value="technical">技术分析</option>
                        <option value="fundamental">基本面分析</option>
                        <option value="quantitative">量化策略</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadStrategies()" class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-filter mr-2"></i>筛选
                    </button>
                </div>
            </div>
        </div>

        <!-- Batch Backtest Section -->
        <div class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-xl p-6 mb-6 border border-purple-500/30">
            <div class="flex items-center gap-3 mb-4">
                <i class="fas fa-layer-group text-2xl text-purple-400"></i>
                <h2 class="text-xl font-bold">批量策略回测</h2>
                <span class="text-sm text-gray-400">- 对一只股票测试所有策略，找出最佳策略</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">股票代码</label>
                    <input type="text" id="batchTicker" placeholder="AAPL"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 uppercase">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">开始日期</label>
                    <input type="date" id="batchStartDate"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">结束日期</label>
                    <input type="date" id="batchEndDate"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">交易频率</label>
                    <select id="batchFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
                        <option value="daily">按天交易</option>
                        <option value="monthly">按月交易</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="startBatchBacktest()" class="w-full bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-rocket mr-2"></i>开始批量回测
                    </button>
                </div>
            </div>

            <!-- Batch Results -->
            <div id="batchResultsContainer" class="hidden mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">回测结果排名（按胜率）</h3>
                    <div id="batchProgress" class="text-sm text-gray-400">
                        <i class="fas fa-spinner fa-spin mr-1"></i>
                        <span id="batchProgressText">进行中...</span>
                    </div>
                </div>

                <!-- Best Strategy Card -->
                <div id="bestStrategyCard" class="hidden bg-gradient-to-r from-yellow-900/50 to-orange-900/50 rounded-xl p-4 mb-4 border border-yellow-500/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-crown text-yellow-400"></i>
                        <span class="font-bold text-yellow-400">最佳策略</span>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold" id="bestStrategyName">-</div>
                            <div class="text-sm text-gray-400">策略名称</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400" id="bestWinRate">-</div>
                            <div class="text-sm text-gray-400">胜率</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-400" id="bestReturn">-</div>
                            <div class="text-sm text-gray-400">总收益</div>
                        </div>
                        <div>
                            <button onclick="startSimulationFromBest()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-play mr-1"></i>开始模拟交易
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-400 border-b border-gray-700">
                                <th class="py-2 px-3">排名</th>
                                <th class="py-2 px-3">策略名称</th>
                                <th class="py-2 px-3">胜率</th>
                                <th class="py-2 px-3">总收益</th>
                                <th class="py-2 px-3">夏普比率</th>
                                <th class="py-2 px-3">最大回撤</th>
                                <th class="py-2 px-3">操作</th>
                            </tr>
                        </thead>
                        <tbody id="batchResultsTable">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Strategies Grid -->
        <div id="strategiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Strategies will be loaded here -->
        </div>

        <!-- Backtest Modal -->
        <div id="backtestModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">运行回测</h2>
                    <button onclick="closeBacktestModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="backtestForm" class="space-y-4">
                    <input type="hidden" id="backtestStrategyId">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">股票代码</label>
                        <input type="text" id="backtestTicker" required
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="例如: AAPL, TSLA, NVDA">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">开始日期</label>
                            <input type="date" id="backtestStartDate" required
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">结束日期</label>
                            <input type="date" id="backtestEndDate" required
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">初始资金</label>
                        <input type="number" id="backtestCapital" value="100000" min="1000" step="1000" required
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="strategyParams" class="space-y-3">
                        <!-- Strategy parameters will be loaded here -->
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-play mr-2"></i>开始回测
                        </button>
                        <button type="button" onclick="closeBacktestModal()" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="resultsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">回测结果</h2>
                    <button onclick="closeResultsModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div id="resultsContent">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let strategies = [];
        let currentBacktestTaskId = null;
        let currentBatchJobId = null;
        let bestBatchStrategy = null;

        // ==================== 批量回测功能 ====================

        // 初始化批量回测日期
        function initBatchDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 1);

            document.getElementById('batchEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('batchStartDate').value = startDate.toISOString().split('T')[0];
        }

        async function startBatchBacktest() {
            const ticker = document.getElementById('batchTicker').value.trim().toUpperCase();
            const startDate = document.getElementById('batchStartDate').value;
            const endDate = document.getElementById('batchEndDate').value;
            const frequency = document.getElementById('batchFrequency').value;

            if (!ticker) {
                alert('请输入股票代码');
                return;
            }

            if (!startDate || !endDate) {
                alert('请选择日期范围');
                return;
            }

            try {
                const response = await fetch('/api/backtest/batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ticker: ticker,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: 100000,
                        trading_frequency: frequency
                    })
                });

                if (!response.ok) throw new Error('启动批量回测失败');

                const data = await response.json();
                currentBatchJobId = data.job_id;

                // 显示结果区域
                document.getElementById('batchResultsContainer').classList.remove('hidden');
                document.getElementById('bestStrategyCard').classList.add('hidden');
                document.getElementById('batchResultsTable').innerHTML = '';
                document.getElementById('batchProgressText').textContent = '正在启动回测...';

                // 开始轮询状态
                pollBatchBacktestStatus();

            } catch (error) {
                console.error('Error starting batch backtest:', error);
                alert('启动批量回测失败: ' + error.message);
            }
        }

        async function pollBatchBacktestStatus() {
            if (!currentBatchJobId) return;

            try {
                const response = await fetch(`/api/backtest/batch/${currentBatchJobId}`);
                if (!response.ok) throw new Error('查询状态失败');

                const data = await response.json();

                // 更新进度
                const progressText = document.getElementById('batchProgressText');
                if (data.status === 'running') {
                    progressText.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> 进度: ${data.progress}% (${data.completed_strategies || 0}/${data.total_strategies || '?'})`;
                    setTimeout(pollBatchBacktestStatus, 2000);
                } else if (data.status === 'completed') {
                    progressText.innerHTML = '<i class="fas fa-check text-green-400 mr-1"></i> 完成';
                    displayBatchResults(data);
                } else if (data.status === 'failed') {
                    progressText.innerHTML = '<i class="fas fa-times text-red-400 mr-1"></i> 失败';
                    alert('批量回测失败: ' + (data.error_message || '未知错误'));
                } else {
                    setTimeout(pollBatchBacktestStatus, 2000);
                }

            } catch (error) {
                console.error('Error polling batch status:', error);
                setTimeout(pollBatchBacktestStatus, 3000);
            }
        }

        function displayBatchResults(data) {
            const tableBody = document.getElementById('batchResultsTable');
            const results = data.all_results || [];

            // 显示最佳策略
            if (data.best_strategy) {
                bestBatchStrategy = data.best_strategy;
                document.getElementById('bestStrategyCard').classList.remove('hidden');
                document.getElementById('bestStrategyName').textContent = data.best_strategy.name || data.best_strategy.strategy_name || '-';
                document.getElementById('bestWinRate').textContent = (data.best_strategy.win_rate || 0).toFixed(1) + '%';
                document.getElementById('bestReturn').textContent = (data.best_strategy.total_return || 0).toFixed(2) + '%';
            }

            // 显示结果表格
            tableBody.innerHTML = results.map((result, index) => {
                const hasError = result.error;
                const rowClass = hasError ? 'text-gray-500' : '';
                const winRateClass = result.win_rate >= 50 ? 'text-green-400' : 'text-red-400';
                const returnClass = result.total_return >= 0 ? 'text-green-400' : 'text-red-400';

                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50 ${rowClass}">
                        <td class="py-3 px-3">
                            ${index === 0 ? '<i class="fas fa-crown text-yellow-400"></i>' : index + 1}
                        </td>
                        <td class="py-3 px-3">${result.strategy_name || '-'}</td>
                        <td class="py-3 px-3 ${winRateClass}">${hasError ? '-' : (result.win_rate || 0).toFixed(1) + '%'}</td>
                        <td class="py-3 px-3 ${returnClass}">${hasError ? '-' : (result.total_return || 0).toFixed(2) + '%'}</td>
                        <td class="py-3 px-3">${hasError ? '-' : (result.sharpe_ratio || 0).toFixed(2)}</td>
                        <td class="py-3 px-3 text-red-400">${hasError ? '-' : (result.max_drawdown || 0).toFixed(2) + '%'}</td>
                        <td class="py-3 px-3">
                            ${hasError ? '<span class="text-red-400 text-sm">错误</span>' : `
                                <button onclick="startSimulationForStrategy(${result.strategy_id}, '${document.getElementById('batchTicker').value}')"
                                    class="text-green-400 hover:text-green-300 text-sm">
                                    <i class="fas fa-play mr-1"></i>模拟
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function startSimulationFromBest() {
            if (!bestBatchStrategy) {
                alert('请先完成批量回测');
                return;
            }

            const ticker = document.getElementById('batchTicker').value.trim().toUpperCase();
            await startSimulationForStrategy(bestBatchStrategy.id || bestBatchStrategy.strategy_id, ticker);
        }

        async function startSimulationForStrategy(strategyId, ticker) {
            if (!confirm(`确定要对 ${ticker} 使用该策略开始2周模拟交易吗？`)) {
                return;
            }

            try {
                const response = await fetch('/api/simulation/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ticker: ticker,
                        strategy_id: strategyId,
                        duration_days: 14,
                        initial_capital: 100000,
                        check_interval: 'daily'
                    })
                });

                if (!response.ok) throw new Error('启动模拟交易失败');

                const data = await response.json();
                alert(`模拟交易已启动！会话ID: ${data.session_id}\n\n系统将每日自动检查信号并执行交易。\n您可以在"模拟交易"页面查看进度。`);

            } catch (error) {
                console.error('Error starting simulation:', error);
                alert('启动模拟交易失败: ' + error.message);
            }
        }

        // ==================== 原有功能 ====================

        async function loadStrategies() {
            try {
                const type = document.getElementById('filterType').value;
                const category = document.getElementById('filterCategory').value;
                
                let url = '/api/strategies?';
                if (type) url += `strategy_type=${type}&`;
                if (category) url += `category=${category}&`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load strategies');
                
                const data = await response.json();
                strategies = data.strategies;
                renderStrategies();
            } catch (error) {
                console.error('Error loading strategies:', error);
                alert('加载策略失败: ' + error.message);
            }
        }

        function renderStrategies() {
            const container = document.getElementById('strategiesContainer');
            
            if (strategies.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12"><p>暂无策略</p></div>';
                return;
            }
            
            container.innerHTML = strategies.map(strategy => {
                const typeLabels = {
                    'trend_following': '趋势跟踪',
                    'mean_reversion': '均值回归',
                    'momentum': '动量策略',
                    'breakout': '突破策略',
                    'value': '价值投资',
                    'growth': '成长股'
                };
                
                const categoryLabels = {
                    'technical': '技术分析',
                    'fundamental': '基本面',
                    'quantitative': '量化'
                };
                
                return `
                    <div class="strategy-card bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold mb-2">${strategy.name}</h3>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="bg-blue-600/30 text-blue-300 px-2 py-1 rounded text-xs">
                                        ${typeLabels[strategy.strategy_type] || strategy.strategy_type}
                                    </span>
                                    <span class="bg-purple-600/30 text-purple-300 px-2 py-1 rounded text-xs">
                                        ${categoryLabels[strategy.category] || strategy.category || '其他'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-gray-400 text-sm mb-4 line-clamp-2">${strategy.description || '无描述'}</p>
                        
                        ${strategy.best_sharpe_ratio !== null ? `
                        <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                            <div class="bg-gray-700/50 rounded-lg p-2">
                                <div class="text-gray-400 text-xs">最佳夏普比率</div>
                                <div class="font-semibold">${strategy.best_sharpe_ratio.toFixed(2)}</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-2">
                                <div class="text-gray-400 text-xs">最佳收益率</div>
                                <div class="font-semibold ${strategy.best_total_return > 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${strategy.best_total_return > 0 ? '+' : ''}${strategy.best_total_return.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex gap-2">
                            <button onclick="openStrategyGuide('${strategy.strategy_type}', '${strategy.name}')" 
                                class="flex-1 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg font-semibold transition-all text-sm">
                                <i class="fas fa-book mr-1"></i>策略教程
                            </button>
                            <button onclick="openBacktestModal(${strategy.id})" 
                                class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-3 py-2 rounded-lg font-semibold transition-all text-sm">
                                <i class="fas fa-play mr-1"></i>运行回测
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 策略教程数据
        const strategyGuides = {
            'trend_following': {
                title: '趋势跟踪策略（双均线）',
                icon: 'fa-arrow-trend-up',
                color: 'blue',
                principle: '趋势跟踪策略基于"趋势一旦形成便会持续"的市场假设。通过识别价格趋势方向，在趋势确立时入场，在趋势反转时出场。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算短期均线（如20日）和长期均线（如50日）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当短期均线上穿长期均线时产生买入信号（金叉）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当短期均线下穿长期均线时产生卖出信号（死叉）</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">均线交叉示意</div><div class="flex items-end justify-center gap-1 h-32"><div class="w-2 bg-blue-500 rounded-t" style="height:40%"></div><div class="w-2 bg-blue-500 rounded-t" style="height:50%"></div><div class="w-2 bg-blue-500 rounded-t" style="height:45%"></div><div class="w-2 bg-green-500 rounded-t" style="height:60%"></div><div class="w-2 bg-green-500 rounded-t" style="height:75%"></div><div class="w-2 bg-green-500 rounded-t" style="height:85%"></div><div class="w-2 bg-green-500 rounded-t" style="height:90%"></div><div class="w-2 bg-yellow-500 rounded-t" style="height:80%"></div><div class="w-2 bg-red-500 rounded-t" style="height:65%"></div></div><div class="flex justify-center gap-4 mt-2 text-xs"><span class="text-blue-400">▬ 短期均线</span><span class="text-green-400">▲ 买入点</span><span class="text-red-400">▼ 卖出点</span></div></div>',
                suitable: '单边趋势行情、牛市或熊市初中期',
                unsuitable: '震荡盘整行情、趋势不明确时期',
                tips: ['延长均线周期可减少假信号但会滞后', '结合成交量确认趋势更可靠', '设置止损保护防止趋势反转损失过大']
            },
            'rsi': {
                title: 'RSI 超买超卖策略',
                icon: 'fa-wave-square',
                color: 'cyan',
                principle: 'RSI（相对强弱指数）是衡量价格变动速度和变化幅度的动量指标。RSI在0-100之间波动，通常30以下为超卖区，70以上为超买区。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算14日RSI指标值</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当RSI低于30时产生买入信号（超卖反弹）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当RSI高于70时产生卖出信号（超买回落）</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">RSI 指标示意</div><div class="relative h-32"><div class="absolute w-full h-1/3 top-0 bg-red-900/30 border-b border-red-500 flex items-center px-2 text-xs text-red-400">超买区 (70+)</div><div class="absolute w-full h-1/3 top-1/3 bg-gray-700/30 flex items-center px-2 text-xs text-gray-400">中性区</div><div class="absolute w-full h-1/3 bottom-0 bg-green-900/30 border-t border-green-500 flex items-center px-2 text-xs text-green-400">超卖区 (30-)</div></div></div>',
                suitable: '震荡盘整行情、区间波动市场',
                unsuitable: '强趋势行情（会持续超买/超卖）',
                tips: ['在强趋势中RSI可能长期处于超买/超卖', '结合价格形态确认反转信号', '可调整阈值适应不同市场']
            },
            'macd': {
                title: 'MACD 金叉死叉策略',
                icon: 'fa-chart-line',
                color: 'pink',
                principle: 'MACD（指数平滑异同移动平均线）通过快慢均线的差值变化捕捉趋势动量。MACD线上穿信号线为金叉（买入），下穿为死叉（卖出）。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-pink-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算12日和26日EMA的差值（MACD线）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-pink-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>计算MACD线的9日EMA（信号线）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-pink-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>MACD上穿信号线买入，下穿卖出</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">MACD 交叉示意</div><div class="flex items-end justify-center gap-1 h-32"><div class="w-2 bg-red-500 rounded-t" style="height:60%"></div><div class="w-2 bg-red-400 rounded-t" style="height:45%"></div><div class="w-2 bg-yellow-500 rounded-t" style="height:30%"></div><div class="w-2 bg-green-400 rounded-t" style="height:40%"></div><div class="w-2 bg-green-500 rounded-t" style="height:55%"></div><div class="w-2 bg-green-600 rounded-t" style="height:70%"></div><div class="w-2 bg-green-500 rounded-t" style="height:60%"></div><div class="w-2 bg-yellow-500 rounded-t" style="height:45%"></div></div><div class="text-xs mt-2 text-gray-400">MACD上穿信号线 → 金叉买入 | 下穿 → 死叉卖出</div></div>',
                suitable: '趋势形成初期、中期趋势跟踪',
                unsuitable: '震荡盘整、趋势末期',
                tips: ['MACD有一定滞后性', '结合柱状图判断动量强弱', '零轴上方金叉信号更强']
            },
            'mean_reversion': {
                title: '均值回归策略',
                icon: 'fa-exchange-alt',
                color: 'purple',
                principle: '均值回归策略基于价格围绕均值波动的统计特性。当价格偏离均值过远时，预期价格将回归均值，从而产生交易机会。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算移动平均线作为"均值"基准</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当价格低于均值一定幅度时买入（超卖）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当价格高于均值一定幅度时卖出（超买）</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">均值回归示意</div><div class="relative h-32 flex items-center"><div class="absolute w-full h-0.5 bg-yellow-500 top-1/2"></div><div class="absolute w-full border-t border-dashed border-green-500 top-1/4"></div><div class="absolute w-full border-t border-dashed border-red-500 top-3/4"></div><div class="flex items-center justify-center gap-1 h-full relative z-10"><div class="w-2 bg-gray-500 rounded" style="height:50%"></div><div class="w-2 bg-gray-500 rounded" style="height:35%"></div><div class="w-2 bg-green-500 rounded" style="height:25%"></div><div class="w-2 bg-gray-500 rounded" style="height:40%"></div><div class="w-2 bg-gray-500 rounded" style="height:55%"></div><div class="w-2 bg-gray-500 rounded" style="height:70%"></div><div class="w-2 bg-red-500 rounded" style="height:80%"></div><div class="w-2 bg-gray-500 rounded" style="height:60%"></div></div></div><div class="flex justify-center gap-4 mt-2 text-xs"><span class="text-yellow-400">▬ 均值</span><span class="text-green-400">买入区</span><span class="text-red-400">卖出区</span></div></div>',
                suitable: '震荡盘整行情、区间波动市场',
                unsuitable: '单边趋势行情、突破性行情',
                tips: ['设置合理的偏离阈值避免过早入场', '配合RSI等超买超卖指标效果更佳', '在强趋势中需要严格止损']
            },
            'momentum': {
                title: '动量策略',
                icon: 'fa-rocket',
                color: 'orange',
                principle: '动量策略基于"强者恒强"的市场规律。买入近期表现强势的资产，卖出表现弱势的资产，追踪价格动量延续。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算过去N日的价格变化率（动量值）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当动量值超过正阈值时买入（强势）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当动量值低于负阈值时卖出（弱势）</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">动量变化示意</div><div class="flex items-end justify-center gap-1 h-32"><div class="w-3 bg-red-500 rounded-t" style="height:20%"></div><div class="w-3 bg-red-400 rounded-t" style="height:30%"></div><div class="w-3 bg-yellow-500 rounded-t" style="height:45%"></div><div class="w-3 bg-green-400 rounded-t" style="height:60%"></div><div class="w-3 bg-green-500 rounded-t" style="height:80%"></div><div class="w-3 bg-green-600 rounded-t" style="height:95%"></div><div class="w-3 bg-green-500 rounded-t" style="height:85%"></div><div class="w-3 bg-yellow-500 rounded-t" style="height:50%"></div></div><div class="text-xs mt-2 text-gray-400">动量由负转正 → 买入信号 | 动量由正转负 → 卖出信号</div></div>',
                suitable: '趋势启动阶段、市场情绪高涨时期',
                unsuitable: '趋势末期、市场转折点附近',
                tips: ['动量策略在趋势中后期可能遭遇反转', '结合趋势过滤器避免震荡市假信号', '适当缩短回看周期可提高灵敏度']
            },
            'breakout': {
                title: '突破策略',
                icon: 'fa-bolt',
                color: 'yellow',
                principle: '突破策略捕捉价格突破关键支撑/阻力位后的延续行情。利用布林带等技术指标识别价格波动区间和突破点。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算布林带上轨、中轨和下轨</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>价格突破上轨时买入（向上突破）</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>价格跌破下轨时卖出（向下突破）</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">布林带突破示意</div><div class="relative h-32"><div class="absolute w-full h-full flex items-center"><div class="w-full h-16 bg-gray-700/50 rounded border border-gray-600"></div></div><div class="flex items-center justify-center gap-1 h-full relative z-10"><div class="w-2 bg-gray-500 rounded" style="height:40%"></div><div class="w-2 bg-gray-500 rounded" style="height:45%"></div><div class="w-2 bg-gray-500 rounded" style="height:50%"></div><div class="w-2 bg-green-500 rounded" style="height:75%"></div><div class="w-2 bg-green-400 rounded" style="height:85%"></div><div class="w-2 bg-green-500 rounded" style="height:80%"></div><div class="w-2 bg-gray-500 rounded" style="height:55%"></div><div class="w-2 bg-red-500 rounded" style="height:25%"></div></div></div><div class="flex justify-center gap-4 mt-2 text-xs"><span class="text-gray-400">▬ 布林带区间</span><span class="text-green-400">▲ 上突破买入</span><span class="text-red-400">▼ 下突破卖出</span></div></div>',
                suitable: '波动收窄后的突破行情、重大事件驱动',
                unsuitable: '假突破频繁的震荡市、流动性差的市场',
                tips: ['配合成交量放大确认突破有效性', '设置止损在突破位附近防止假突破', '波动率收窄期间突破信号更可靠']
            },
            'value': {
                title: '价值投资策略',
                icon: 'fa-gem',
                color: 'emerald',
                principle: '价值投资策略寻找被市场低估的资产。当价格显著低于内在价值时买入，等待市场纠正估值偏差获取收益。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-emerald-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>使用长期均线（如50日）作为价值参考</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-emerald-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当价格大幅低于均线时视为低估买入</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-emerald-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当价格回归或高于均线时考虑卖出</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">价值区间示意</div><div class="relative h-32 flex flex-col justify-center"><div class="h-8 bg-red-900/30 border-b border-red-500 flex items-center px-2 text-xs text-red-400">高估区域</div><div class="h-8 bg-yellow-900/30 border-b border-yellow-500 flex items-center px-2 text-xs text-yellow-400">合理估值</div><div class="h-8 bg-green-900/30 flex items-center px-2 text-xs text-green-400">低估区域 → 买入机会</div></div></div>',
                suitable: '市场恐慌性下跌、优质资产被错杀时期',
                unsuitable: '泡沫期、基本面恶化的标的',
                tips: ['需要较长持有周期等待价值回归', '结合基本面分析提高准确性', '分批建仓降低抄底风险']
            },
            'growth': {
                title: '成长股策略',
                icon: 'fa-seedling',
                color: 'teal',
                principle: '成长股策略追踪高增长潜力的资产。通过识别强势动量和持续上涨趋势，投资于成长性突出的标的。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-teal-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>计算中期动量指标识别成长趋势</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-teal-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>当动量持续为正且超过阈值时买入</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-teal-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>当动量转弱或趋势反转时卖出</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">成长曲线示意</div><div class="flex items-end justify-center gap-1 h-32"><div class="w-3 bg-teal-800 rounded-t" style="height:15%"></div><div class="w-3 bg-teal-700 rounded-t" style="height:25%"></div><div class="w-3 bg-teal-600 rounded-t" style="height:40%"></div><div class="w-3 bg-teal-500 rounded-t" style="height:55%"></div><div class="w-3 bg-teal-400 rounded-t" style="height:70%"></div><div class="w-3 bg-teal-300 rounded-t" style="height:85%"></div><div class="w-3 bg-teal-200 rounded-t" style="height:95%"></div></div><div class="text-xs mt-2 text-gray-400">持续正动量 = 成长信号</div></div>',
                suitable: '新兴行业崛起期、科技创新周期',
                unsuitable: '经济衰退期、行业成熟饱和阶段',
                tips: ['成长股波动较大需控制仓位', '关注成长持续性而非短期涨幅', '适当止盈锁定利润']
            },
            'custom': {
                title: '自定义策略',
                icon: 'fa-cogs',
                color: 'indigo',
                principle: '自定义策略基于用户选择的基础策略进行参数调整和组合，实现个性化的交易逻辑。',
                mechanism: '<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">1</div><div>选择一个基础策略作为核心逻辑</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">2</div><div>根据市场特点调整策略参数</div></div><div class="flex items-center gap-3"><div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">3</div><div>通过回测验证参数有效性</div></div></div>',
                diagram: '<div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-gray-400 mb-2">策略组合示意</div><div class="flex items-center justify-center gap-2"><div class="bg-blue-600/50 px-3 py-2 rounded text-sm">基础策略</div><span class="text-2xl">+</span><div class="bg-purple-600/50 px-3 py-2 rounded text-sm">自定义参数</div><span class="text-2xl">=</span><div class="bg-indigo-600/50 px-3 py-2 rounded text-sm">个性化策略</div></div></div>',
                suitable: '根据选择的基础策略而定',
                unsuitable: '参数过度优化可能导致过拟合',
                tips: ['避免过度优化导致曲线拟合', '在不同市场环境下测试策略稳健性', '定期回顾和调整参数']
            }
        };
        
        function openStrategyGuide(strategyType, strategyName) {
            const guide = strategyGuides[strategyType] || strategyGuides['custom'];
            const colors = {
                blue: 'from-blue-600 to-blue-800',
                purple: 'from-purple-600 to-purple-800',
                orange: 'from-orange-600 to-orange-800',
                yellow: 'from-yellow-600 to-yellow-800',
                emerald: 'from-emerald-600 to-emerald-800',
                teal: 'from-teal-600 to-teal-800',
                indigo: 'from-indigo-600 to-indigo-800'
            };
            
            const modal = document.createElement('div');
            modal.id = 'strategyGuideModal';
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r ${colors[guide.color]} p-6 rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas ${guide.icon} text-3xl"></i>
                                <div>
                                    <h2 class="text-2xl font-bold">${guide.title}</h2>
                                    <p class="text-sm opacity-80">${strategyName}</p>
                                </div>
                            </div>
                            <button onclick="document.getElementById('strategyGuideModal').remove()" class="text-white/80 hover:text-white">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <section>
                            <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fas fa-lightbulb text-yellow-400"></i>策略原理</h3>
                            <p class="text-gray-300">${guide.principle}</p>
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fas fa-cog text-blue-400"></i>运作机制</h3>
                            ${guide.mechanism}
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fas fa-chart-bar text-green-400"></i>图解说明</h3>
                            ${guide.diagram}
                        </section>
                        
                        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-900/30 border border-green-700 rounded-xl p-4">
                                <h4 class="font-semibold text-green-400 mb-2"><i class="fas fa-check-circle mr-2"></i>适合场景</h4>
                                <p class="text-sm text-gray-300">${guide.suitable}</p>
                            </div>
                            <div class="bg-red-900/30 border border-red-700 rounded-xl p-4">
                                <h4 class="font-semibold text-red-400 mb-2"><i class="fas fa-times-circle mr-2"></i>不适合场景</h4>
                                <p class="text-sm text-gray-300">${guide.unsuitable}</p>
                            </div>
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fas fa-star text-purple-400"></i>实战技巧</h3>
                            <div class="space-y-2">
                                ${guide.tips.map(tip => `<div class="flex items-start gap-2 text-sm text-gray-300"><i class="fas fa-angle-right text-purple-400 mt-1"></i><span>${tip}</span></div>`).join('')}
                            </div>
                        </section>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        async function openBacktestModal(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) return;
            
            document.getElementById('backtestStrategyId').value = strategyId;
            document.getElementById('backtestTicker').value = '';
            
            // Set default dates (1 year back to today)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 1);
            
            document.getElementById('backtestEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('backtestStartDate').value = startDate.toISOString().split('T')[0];
            
            // Load strategy parameters
            const paramsDiv = document.getElementById('strategyParams');
            paramsDiv.innerHTML = '';
            
            if (strategy.default_params && Object.keys(strategy.default_params).length > 0) {
                paramsDiv.innerHTML = '<h3 class="text-lg font-semibold mb-3">策略参数</h3>';
                Object.entries(strategy.default_params).forEach(([key, value]) => {
                    paramsDiv.innerHTML += `
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">${key}</label>
                            <input type="number" name="param_${key}" value="${value}" step="0.01"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                    `;
                });
            }
            
            document.getElementById('backtestModal').classList.remove('hidden');
        }

        function closeBacktestModal() {
            document.getElementById('backtestModal').classList.add('hidden');
        }

        document.getElementById('backtestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const strategyId = parseInt(document.getElementById('backtestStrategyId').value);
            const ticker = document.getElementById('backtestTicker').value.toUpperCase();
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const initialCapital = parseFloat(document.getElementById('backtestCapital').value);
            
            // Collect parameters
            const params = {};
            const paramInputs = document.querySelectorAll('[name^="param_"]');
            paramInputs.forEach(input => {
                const key = input.name.replace('param_', '');
                params[key] = parseFloat(input.value);
            });
            
            try {
                const response = await fetch('/api/backtest/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        strategy_id: strategyId,
                        ticker: ticker,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: initialCapital,
                        params: params
                    })
                });
                
                if (!response.ok) throw new Error('Failed to start backtest');
                
                const data = await response.json();
                currentBacktestTaskId = data.task_id;
                
                closeBacktestModal();
                pollBacktestStatus();
                
            } catch (error) {
                alert('启动回测失败: ' + error.message);
            }
        });

        async function pollBacktestStatus() {
            if (!currentBacktestTaskId) return;
            
            try {
                const response = await fetch(`/api/backtest/status/${currentBacktestTaskId}`);
                const status = await response.json();
                
                if (status.status === 'completed') {
                    showBacktestResults(status.results);
                    currentBacktestTaskId = null;
                } else if (status.status === 'failed') {
                    alert('回测失败: ' + (status.error || 'Unknown error'));
                    currentBacktestTaskId = null;
                } else {
                    setTimeout(pollBacktestStatus, 2000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                setTimeout(pollBacktestStatus, 2000);
            }
        }

        function showBacktestResults(results) {
            const content = document.getElementById('resultsContent');
            
            // Calculate metrics
            const totalReturn = results.total_return || 0;
            const sharpeRatio = results.sharpe_ratio || 0;
            const maxDrawdown = results.max_drawdown || 0;
            const winRate = results.win_rate || 0;
            const annualizedReturn = results.annualized_return || 0;
            const profitFactor = results.profit_factor || 0;
            
            // 生成策略分析和建议
            const analysis = generateStrategyAnalysis(totalReturn, sharpeRatio, maxDrawdown, winRate, profitFactor, annualizedReturn);
            
            content.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-1">总收益率</div>
                        <div class="text-2xl font-bold ${totalReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                        </div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-1">夏普比率</div>
                        <div class="text-2xl font-bold ${sharpeRatio >= 1 ? 'text-green-400' : sharpeRatio >= 0.5 ? 'text-yellow-400' : 'text-red-400'}">${sharpeRatio.toFixed(2)}</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-1">最大回撤</div>
                        <div class="text-2xl font-bold ${maxDrawdown <= 10 ? 'text-green-400' : maxDrawdown <= 20 ? 'text-yellow-400' : 'text-red-400'}">${maxDrawdown.toFixed(2)}%</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-1">胜率</div>
                        <div class="text-2xl font-bold ${winRate >= 50 ? 'text-green-400' : 'text-yellow-400'}">${winRate.toFixed(2)}%</div>
                    </div>
                </div>
                
                <!-- 策略评估 -->
                <div class="bg-gradient-to-r ${analysis.grade === 'A' ? 'from-green-900/50 to-emerald-900/50 border-green-600' : analysis.grade === 'B' ? 'from-blue-900/50 to-cyan-900/50 border-blue-600' : analysis.grade === 'C' ? 'from-yellow-900/50 to-amber-900/50 border-yellow-600' : 'from-red-900/50 to-rose-900/50 border-red-600'} border rounded-xl p-5 mb-6">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="text-4xl font-bold ${analysis.grade === 'A' ? 'text-green-400' : analysis.grade === 'B' ? 'text-blue-400' : analysis.grade === 'C' ? 'text-yellow-400' : 'text-red-400'}">${analysis.grade}</div>
                        <div>
                            <div class="text-lg font-semibold">${analysis.title}</div>
                            <div class="text-sm text-gray-300">${analysis.subtitle}</div>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm">${analysis.description}</p>
                </div>
                
                <!-- 图表区域 -->
                <div class="grid grid-cols-1 gap-6 mb-6">
                    <!-- 价格与买卖点图表 -->
                    <div class="bg-gray-700/30 rounded-xl p-4">
                        <h3 class="text-lg font-semibold mb-3"><i class="fas fa-chart-bar mr-2 text-green-400"></i>价格走势与买卖点</h3>
                        <canvas id="priceTradeChart" height="150"></canvas>
                        <div class="flex justify-center gap-6 mt-3 text-sm">
                            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> 价格</span>
                            <span class="flex items-center gap-2"><span class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-l-transparent border-r-transparent border-b-green-500"></span> 买入点</span>
                            <span class="flex items-center gap-2"><span class="w-0 h-0 border-l-4 border-r-4 border-t-8 border-l-transparent border-r-transparent border-t-red-500"></span> 卖出点</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-700/30 rounded-xl p-4">
                        <h3 class="text-lg font-semibold mb-3"><i class="fas fa-chart-line mr-2 text-blue-400"></i>收益曲线</h3>
                        <canvas id="equityChart" height="120"></canvas>
                    </div>
                    <div class="bg-gray-700/30 rounded-xl p-4">
                        <h3 class="text-lg font-semibold mb-3"><i class="fas fa-chart-area mr-2 text-red-400"></i>回撤分析</h3>
                        <canvas id="drawdownChart" height="120"></canvas>
                    </div>
                </div>

                <!-- 交易记录明细 -->
                ${(results.trade_history && results.trade_history.length > 0) ? `
                <div class="bg-gray-700/30 rounded-xl p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3"><i class="fas fa-list mr-2 text-purple-400"></i>交易记录明细</h3>
                    <div class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-gray-800">
                                <tr class="text-gray-400 border-b border-gray-600">
                                    <th class="text-left py-2 px-2">日期</th>
                                    <th class="text-left py-2 px-2">操作</th>
                                    <th class="text-right py-2 px-2">价格</th>
                                    <th class="text-right py-2 px-2">股数</th>
                                    <th class="text-right py-2 px-2">金额</th>
                                    <th class="text-right py-2 px-2">盈亏</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.trade_history.map(t => `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="py-2 px-2">${t.date}</td>
                                        <td class="py-2 px-2">
                                            <span class="px-2 py-1 rounded text-xs font-semibold ${t.action === 'buy' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}">
                                                ${t.action === 'buy' ? '买入' : '卖出'}
                                            </span>
                                        </td>
                                        <td class="text-right py-2 px-2">$${t.price.toFixed(2)}</td>
                                        <td class="text-right py-2 px-2">${t.shares}</td>
                                        <td class="text-right py-2 px-2">$${t.value.toFixed(2)}</td>
                                        <td class="text-right py-2 px-2 ${t.pnl > 0 ? 'text-green-400' : t.pnl < 0 ? 'text-red-400' : 'text-gray-400'}">
                                            ${t.pnl !== undefined ? (t.pnl > 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <!-- 详细统计 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-2"><i class="fas fa-exchange-alt mr-2"></i>交易统计</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span>总交易次数:</span><span class="font-semibold">${results.total_trades || 0}</span></div>
                            <div class="flex justify-between"><span>盈利交易:</span><span class="font-semibold text-green-400">${results.winning_trades || 0}</span></div>
                            <div class="flex justify-between"><span>亏损交易:</span><span class="font-semibold text-red-400">${results.losing_trades || 0}</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-2"><i class="fas fa-dollar-sign mr-2"></i>盈亏分析</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span>平均盈利:</span><span class="font-semibold text-green-400">$${(results.avg_win || 0).toFixed(2)}</span></div>
                            <div class="flex justify-between"><span>平均亏损:</span><span class="font-semibold text-red-400">$${(results.avg_loss || 0).toFixed(2)}</span></div>
                            <div class="flex justify-between"><span>盈亏比:</span><span class="font-semibold">${profitFactor.toFixed(2)}</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-gray-400 text-sm mb-2"><i class="fas fa-percentage mr-2"></i>收益指标</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span>年化收益:</span><span class="font-semibold ${annualizedReturn >= 0 ? 'text-green-400' : 'text-red-400'}">${annualizedReturn.toFixed(2)}%</span></div>
                            <div class="flex justify-between"><span>最终资金:</span><span class="font-semibold">$${(results.final_value || 0).toLocaleString()}</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- 分析建议 -->
                <div class="bg-gray-700/30 rounded-xl p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-3"><i class="fas fa-lightbulb mr-2 text-yellow-400"></i>策略分析与建议</h3>
                    <div class="space-y-3 text-sm text-gray-300">
                        ${analysis.suggestions.map(s => `<div class="flex items-start gap-2"><i class="fas fa-check-circle text-blue-400 mt-1"></i><span>${s}</span></div>`).join('')}
                    </div>
                </div>
                
                <!-- 市场适用性 -->
                <div class="bg-gray-700/30 rounded-xl p-5">
                    <h3 class="text-lg font-semibold mb-3"><i class="fas fa-compass mr-2 text-purple-400"></i>市场适用性分析</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="text-green-400 font-semibold mb-1">适合市场环境</div>
                            <p class="text-gray-400">${analysis.suitableMarket}</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="text-red-400 font-semibold mb-1">不适合市场环境</div>
                            <p class="text-gray-400">${analysis.unsuitableMarket}</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="text-blue-400 font-semibold mb-1">风险提示</div>
                            <p class="text-gray-400">${analysis.riskWarning}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Draw equity curve chart
            if (results.equity_curve && results.equity_curve.length > 0) {
                // 绘制价格与买卖点图表
                if (results.trade_history && results.trade_history.length > 0) {
                    drawPriceTradeChart(results);
                }

                const ctx = document.getElementById('equityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: results.equity_curve.map((_, i) => `Day ${i + 1}`),
                        datasets: [{
                            label: 'Portfolio Value',
                            data: results.equity_curve,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: false, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#9ca3af', maxTicksLimit: 10 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        }
                    }
                });
                
                // Draw drawdown chart
                const drawdowns = calculateDrawdowns(results.equity_curve);
                const ddCtx = document.getElementById('drawdownChart').getContext('2d');
                new Chart(ddCtx, {
                    type: 'line',
                    data: {
                        labels: drawdowns.map((_, i) => `Day ${i + 1}`),
                        datasets: [{
                            label: 'Drawdown',
                            data: drawdowns,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: '#9ca3af', callback: v => v.toFixed(1) + '%' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#9ca3af', maxTicksLimit: 10 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        }
                    }
                });
            }
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function drawPriceTradeChart(results) {
            const canvas = document.getElementById('priceTradeChart');
            if (!canvas) return;

            const trades = results.trade_history || [];
            const equityCurve = results.equity_curve || [];

            // 从交易记录中提取价格数据
            const buyTrades = trades.filter(t => t.action === 'buy');
            const sellTrades = trades.filter(t => t.action === 'sell');

            // 创建价格时间序列（使用equity curve的长度作为时间轴）
            const labels = equityCurve.map((_, i) => `Day ${i + 1}`);

            // 创建买入和卖出点的数据
            const buyPoints = new Array(labels.length).fill(null);
            const sellPoints = new Array(labels.length).fill(null);

            // 如果有交易历史，用交易价格；否则用equity curve
            // 为简化，使用equity curve来展示价值变化
            const priceData = equityCurve;

            // 标记买卖点（基于交易次数估算位置）
            if (trades.length > 0) {
                const interval = Math.floor(labels.length / (trades.length + 1));
                trades.forEach((trade, idx) => {
                    const position = Math.min((idx + 1) * interval, labels.length - 1);
                    if (trade.action === 'buy') {
                        buyPoints[position] = priceData[position];
                    } else {
                        sellPoints[position] = priceData[position];
                    }
                });
            }

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '组合价值',
                            data: priceData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: '买入点',
                            data: buyPoints,
                            borderColor: '#22c55e',
                            backgroundColor: '#22c55e',
                            pointStyle: 'triangle',
                            pointRadius: 10,
                            pointHoverRadius: 12,
                            showLine: false
                        },
                        {
                            label: '卖出点',
                            data: sellPoints,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            pointStyle: 'triangle',
                            rotation: 180,
                            pointRadius: 10,
                            pointHoverRadius: 12,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === '买入点' && context.raw !== null) {
                                        return '买入: $' + context.raw.toLocaleString();
                                    }
                                    if (context.dataset.label === '卖出点' && context.raw !== null) {
                                        return '卖出: $' + context.raw.toLocaleString();
                                    }
                                    if (context.dataset.label === '组合价值') {
                                        return '价值: $' + context.raw.toLocaleString();
                                    }
                                    return context.raw;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: '#9ca3af', callback: v => '$' + v.toLocaleString() },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af', maxTicksLimit: 10 },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function calculateDrawdowns(equityCurve) {
            if (!equityCurve || equityCurve.length === 0) return [];
            let runningMax = equityCurve[0];
            return equityCurve.map(value => {
                runningMax = Math.max(runningMax, value);
                return ((value - runningMax) / runningMax) * 100;
            });
        }
        
        function generateStrategyAnalysis(totalReturn, sharpeRatio, maxDrawdown, winRate, profitFactor, annualizedReturn) {
            let grade = 'D';
            let title = '需要改进';
            let subtitle = '策略表现欠佳';
            let description = '';
            let suggestions = [];
            let suitableMarket = '';
            let unsuitableMarket = '';
            let riskWarning = '';
            
            // 综合评分
            let score = 0;
            if (totalReturn > 20) score += 3; else if (totalReturn > 10) score += 2; else if (totalReturn > 0) score += 1;
            if (sharpeRatio > 1.5) score += 3; else if (sharpeRatio > 1) score += 2; else if (sharpeRatio > 0.5) score += 1;
            if (maxDrawdown < 10) score += 3; else if (maxDrawdown < 20) score += 2; else if (maxDrawdown < 30) score += 1;
            if (winRate > 55) score += 2; else if (winRate > 45) score += 1;
            if (profitFactor > 2) score += 2; else if (profitFactor > 1.5) score += 1;
            
            if (score >= 10) { grade = 'A'; title = '表现优秀'; subtitle = '策略具有良好的风险收益特征'; }
            else if (score >= 7) { grade = 'B'; title = '表现良好'; subtitle = '策略有一定优势但仍有提升空间'; }
            else if (score >= 4) { grade = 'C'; title = '表现一般'; subtitle = '策略需要优化部分参数'; }
            
            // 生成描述
            if (totalReturn > 0) {
                description = `该策略在回测期间实现了${totalReturn.toFixed(1)}%的正收益，`;
            } else {
                description = `该策略在回测期间出现了${Math.abs(totalReturn).toFixed(1)}%的亏损，`;
            }
            
            if (sharpeRatio >= 1) {
                description += `风险调整后收益良好（夏普比率${sharpeRatio.toFixed(2)}），`;
            } else {
                description += `风险调整后收益偏低（夏普比率${sharpeRatio.toFixed(2)}），`;
            }
            
            description += `最大回撤控制在${maxDrawdown.toFixed(1)}%，胜率为${winRate.toFixed(1)}%。`;
            
            // 生成建议
            if (sharpeRatio < 1) suggestions.push('考虑优化入场/出场时机以提高风险调整后收益');
            if (maxDrawdown > 20) suggestions.push('建议增加止损机制或降低仓位以控制回撤');
            if (winRate < 45) suggestions.push('可以尝试调整策略参数提高胜率，或确保盈亏比足够高');
            if (profitFactor < 1.5) suggestions.push('考虑优化止盈止损比例以提高盈亏比');
            if (totalReturn < 10) suggestions.push('可以尝试更长的回测周期或不同的市场环境验证策略稳定性');
            if (suggestions.length === 0) suggestions.push('策略表现稳健，建议在实盘前进行更多样本外测试');
            
            // 市场适用性
            if (sharpeRatio > 1 && maxDrawdown < 15) {
                suitableMarket = '稳定上涨或震荡市场，波动率适中的环境';
                unsuitableMarket = '高波动率或快速反转的市场环境';
            } else if (winRate > 50) {
                suitableMarket = '趋势明确的市场，适合跟随主要趋势';
                unsuitableMarket = '横盘震荡或频繁反转的市场';
            } else {
                suitableMarket = '需要进一步测试确定最佳市场环境';
                unsuitableMarket = '高度不确定或流动性差的市场';
            }
            
            // 风险提示
            if (maxDrawdown > 30) {
                riskWarning = '回撤较大，实盘需严格控制仓位和设置止损';
            } else if (maxDrawdown > 20) {
                riskWarning = '注意回撤风险，建议分批建仓并设置止损线';
            } else {
                riskWarning = '风险控制良好，但仍需关注极端市场情况';
            }
            
            return { grade, title, subtitle, description, suggestions, suitableMarket, unsuitableMarket, riskWarning };
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            initBatchDates();
        });
    </script>
</body>
</html>
